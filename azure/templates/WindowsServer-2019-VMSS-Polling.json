{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "defaultValue": "adminuser",
            "type": "string",
            "metadata": {
                "description": "The name of the administrator of the new VM. Exclusion list: 'admin','administrator'"
            }
        },
        "adminPassword": {
            "defaultValue": "",
            "type": "securestring",
            "metadata": {
              "description": "The password for the administrator account of the new VM"
            }
        },
        "virtualMachineScaleSetsName": {
            "defaultValue": "Your_ScaleSetName",
            "type": "string",
            "metadata": {
                "description": "The name of the VM scale set"
            }
        },
        "virtualNetworkName": {
            "defaultValue": "Your_VNetName",
            "type": "string",
            "metadata": {
                "description": "VNET Name"
            }
        },
        "rdpIpAddress": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "IP address of your machine to access via RDP"
            }
        },
        "networkSecurityGroupName": {
            "defaultValue": "Your_nsg",
            "type": "string",
            "metadata": {
                "description": "Network Security Group Name"
            }
        },
        "virtualNetworkResourceGroup": {
            "defaultValue": "Your_Resource_Group_Name",
            "type": "string",
            "metadata": {
                "description": "Resource Group VNET is deployed in"
            }
        },
        "subnetName": {
            "defaultValue": "YourNamed-Subnet",
            "type": "string",
            "metadata": {
                "description": "Name of the subnet inside the VNET"
            }
        },
        "octopusServerUrl": {
            "defaultValue": "https://your_octopus_server",
            "type": "string",
            "metadata": {
                "description": "Octopus Server url"
            }
        },
        "octopusApiKey": {
            "defaultValue": "API-XXXXXXXXXXXX",
            "type": "string",
            "metadata": {
                "description": "Octopus Api Key"
            }
        },
        "octopusRoles": {
            "defaultValue": "Your_Role",
            "type": "string",
            "metadata": {
                "description": "Octopus roles"
            }
        },
        "octopusSpaceName": {
            "defaultValue": "Your_Role",
            "type": "string",
            "metadata": {
                "description": "Octopus Space Name"
            }
        },
        "octopusEnvs": {
            "defaultValue": "Your_Environment",
            "type": "string",
            "metadata": {
                "description": "Octopus Environments"
            }
        }
    },
    "variables": {
        "computerNamePrefix": "[concat(parameters('virtualMachineScaleSetsName'),'i')]",
        "nicName": "[concat(parameters('virtualMachineScaleSetsName'), 'Nic')]", 
        "nicIpConfigName": "[concat(parameters('virtualMachineScaleSetsName'), 'IpConfig')]",
        "vnetID": "[resourceId(parameters('virtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "subnetID": "[concat(variables('vnetID'),'/subnets/', parameters('subnetName'))]",
        "networkSecurityGroupID": "[resourceId(parameters('virtualNetworkResourceGroup'), 'Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
    },
    "resources": [
    {
        "apiVersion": "2015-06-15",
        "type": "Microsoft.Network/networkSecurityGroups",
        "name": "[parameters('networkSecurityGroupName')]",
        "location": "[resourceGroup().location]",
        "properties": {
            "securityRules": [
            {
                "name": "default-allow-rdp",
                "properties": {
                "description": "Allow RDP",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[parameters('rdpIpAddress')]",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 1000,
                "direction": "Inbound"
                }
            },
            {
                "name": "default-allow-Octopus",
                "properties": {
                "description": "Allow Octopus",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "10933",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 1001,
                "direction": "Inbound"
                }
            }                 
            ]
        }
        },
        {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "apiVersion": "2019-03-01",
            "name": "[parameters('virtualMachineScaleSetsName')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard_B2s",
                "tier": "Standard",
                "capacity": 1
            },
            "properties": {
                "singlePlacementGroup": true,
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "virtualMachineProfile": {
                    "osProfile": {
                        "computerNamePrefix": "[variables('computerNamePrefix')]",
                        "adminUsername": "[parameters('adminUsername')]",
                        "adminPassword": "[parameters('adminPassword')]",
                        "windowsConfiguration": {
                            "provisionVMAgent": true,
                            "enableAutomaticUpdates": true
                        },
                        "secrets": []
                    },
                    "storageProfile": {
                        "osDisk": {
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                                "storageAccountType": "Standard_LRS"
                            }
                        },
                        "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "2019-Datacenter",
                            "version": "latest"
                        }
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "[variables('nicName')]",
                                "properties": {
                                    "primary": true,
                                    "enableAcceleratedNetworking": false,
                                    "networkSecurityGroup": {
                                        "id": "[variables('networkSecurityGroupID')]"
                                    },
                                    "dnsSettings": {
                                        "dnsServers": []
                                    },
                                    "enableIPForwarding": false,
                                    "ipConfigurations": [
                                        {
                                            "name": "[variables('nicIpConfigName')]",
                                            "properties": {
                                                "publicIPAddressConfiguration": {
                                                    "name": "pub1",
                                                    "properties": {
                                                        "idleTimeoutInMinutes": 15,
                                                        "ipTags": []
                                                    }
                                                },
                                                "subnet": {
                                                    "id": "[variables('subnetID')]"
                                                },
                                                "privateIPAddressVersion": "IPv4"
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "extensionProfile": {
                        "extensions": [
                            {
                              "name": "customScript",
                              "properties": {
                                "publisher": "Microsoft.Compute",
                                "settings": {
                                  "fileUris": [
                                    "https://raw.githubusercontent.com/OctopusSamples/IaC/master/azure/bootstrap/BootstrapPollingTentacle.ps1"
                                  ]
                                },
                                "typeHandlerVersion": "1.8",
                                "autoUpgradeMinorVersion": true,
                                "protectedSettings": {
                                    "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -file BootstrapPollingTentacle.ps1', ' ', parameters('octopusServerUrl'), ' ', parameters('octopusApiKey'), ' ', parameters('octopusEnvs'), ' ', parameters('octopusRoles'), ' ', parameters('octopusSpaceName'))]"
                                },
                                "type": "CustomScriptExtension"
                              }
                            }
                          ]
                    },
                    "priority": "Regular"
                },
                "overprovision": true,
                "doNotRunExtensionsOnOverprovisionedVMs": false,
                "platformFaultDomainCount": 5
            }
        }
    ]
}